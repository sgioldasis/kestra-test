namespace: kaizen.manchester
id: dbt_test_job_k8s

inputs:
  - id: dbt_command
    type: STRING
    defaults: "dbt build"

tasks:
  - id: wdir
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
      - id: clone
        type: io.kestra.plugin.git.Clone
        url: https://github.com/sgioldasis/dbt-test.git
        branch: main
        directory: dbt_project

      - id: dbt
        type: io.kestra.plugin.scripts.shell.Commands
        taskRunner:
          type: io.kestra.plugin.core.runner.Process
        commands:
          - pip install dbt-databricks --quiet --no-warn-script-location
          - export PATH=$PATH:$(python3 -m site --user-base)/bin
          - |
            cat <<EOF > profiles.yml
            default:
              target: dev
              outputs:
                dev:
                  type: databricks
                  host: dbc-a8f6bc8e-f728.cloud.databricks.com
                  http_path: /sql/1.0/warehouses/333120755706219a
                  token: "{{ secret('DATABRICKS_TOKEN') }}"
                  catalog: test
                  schema: ice
                  threads: 4
            EOF
          - dbt deps --project-dir dbt_project --profiles-dir .
          - dbt build --project-dir dbt_project --profiles-dir .
